---
title: "MMS Project Pieces: Data Exploration and Visualization"
author: "Samantha Piatt"
date: April 4, 2018
output: pdf_document
---
```{r page_options, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, fig.asp = 0.88, fig.width = 4)

library(MASS)
library(ggplot2)
library(splines)
library(magrittr)

source("GetDataFunctions.R")
source("ExperimentalFunctions.R")
```
```{r}
#data <- rbind(merge_sitl("mms_20151016.csv", "sitl_20151016.csv"), merge_sitl("mms_20151204.csv", "sitl_20151204.csv"))
data <- merge_sitl("mms_20151016.csv", "sitl_20151016.csv")
data$SelectedF <- as.factor(data$Selected)
train <- split_train(data)
test <- split_test(data)

DES_set <- c("DES_Density", "DES_Temperature_para", "DES_Temperature_perp", "DES_Velocity_x", 
             "DES_Velocity_y", "DES_Velocity_z")
DIS_set <- c("DIS_Density", "DIS_Temperature_para", "DIS_Temperature_perp", "DIS_Velocity_x",
             "DIS_Velocity_y", "DIS_Velocity_z")
FGM_set <- c("FGM_Magnetic_Field_w", "FGM_Magnetic_Field_x", "FGM_Magnetic_Field_y",
             "FGM_Magnetic_Field_z")
SEL_set <- c("Time", "Selected")
featureSubset <- c(DES_set, DIS_set, FGM_set)
```

# Data Exploration and Visualization
```{r, fig.width = 12, fig.asp = 0.75, fig.align = "center"}
DES <- reshape::melt(data.frame(data[, DES_set], Time = data$Time), id = 'Time')
DIS <- reshape::melt(data.frame(data[, DIS_set], Time = data$Time), id = 'Time')
FGM <- reshape::melt(data.frame(data[, FGM_set], Time = data$Time), id = 'Time')
SEL <- data.frame(X = data$Time, Y = data$Selected)

remove_axis <- theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.line.x = element_blank())
remove_legend <- theme(legend.position='none')
theme_set(theme_grey() + theme(legend.justification = "left", plot.margin = margin(0, 0, 0, 0)))

spDES <- ggplot(DES, aes(x = Time, y = value, color = variable)) + geom_smooth(method = "lm", formula = y ~ ns(x, df = 100), se = FALSE) + remove_axis +
  ylab("DES") + guides(color = guide_legend(title = "DES")) + labs(title = "Features Grouped by Instrument and Time")
spDIS <- ggplot(DIS, aes(x = Time, y = value, color = variable)) + geom_smooth(method = "lm", formula = y ~ ns(x, df = 100), se = FALSE) + remove_axis +
  ylab("DIS") + guides(color = guide_legend(title = "DIS")) + theme(plot.title = element_blank())
spFGM <- ggplot(FGM, aes(x = Time, y = value, color = variable)) + geom_smooth(method = "lm", formula = y ~ ns(x, df = 100), se = FALSE) + remove_axis +
  ylab("FGM") + guides(color = guide_legend(title = "FGM"))
pSEL <- ggplot(SEL, aes(x = X, y = Y)) + geom_line() + xlab("Time in Seconds")+ scale_y_discrete(name = "Selected", limits = c(0, 1))

lDES <- cowplot::get_legend(spDES)
lDIS <- cowplot::get_legend(spDIS)
lFGM <- cowplot::get_legend(spFGM)

cowplot::plot_grid(
  cowplot::plot_grid(spDES + remove_legend, spDIS + remove_legend, spFGM + remove_legend, pSEL, align = "hv", ncol = 1, rel_heights = c(1, 1, 1, 0.4)),
  cowplot::plot_grid(lDES, lDIS, lFGM, NULL, ncol = 1, rel_heights = c(1, 1, 1, 0.4)),
  rel_widths = c(5, 1)
)
```

Looking at these plots, the DIS values don't seem to influence whether or not the SITL selected that time point. So we can likely leave it out, or it will get excluded in reduction automatically.

Another note, DES_Temperature para & perp seems to have a linear relationship.

It also looks like FGM_Magnetic_Field positional variables (like x, y, z) seem to have a relationship of sorts, which makes sense, but the relationship is not clear (to me).

DES Density and FGM Mag. Field para/perp have a relationship that looks similar to 1/x.

```{r, fig.width = 8, fig.asp = 1.5, fig.align = "center"}
cowplot::plot_grid(
  ggplot(data.frame(Para = train$DES_Temperature_para, Perp = train$DES_Temperature_perp), aes(x = Para, y = Perp)) + 
    geom_point(colour = "#591d91", shape = 1) + theme_grey() + labs(title = "DES Temperature"),
  ggplot(data.frame(Y = train$FGM_Magnetic_Field_y, Z = train$FGM_Magnetic_Field_z), aes(x = Y, y = Z, color = "#8f8699")) + 
    geom_point(colour = "#591d91", shape = 1) + theme_grey() + labs(title = "FGM Magnetic Field"),
  ggplot(data.frame(Density = train$DES_Density, Velocity = train$DES_Velocity_x), aes(y = Density, x = Velocity)) + 
    geom_point(colour = "#591d91", shape = 1) + theme_grey() +
    labs(title = "DES Density & Velocity X"),
  ggplot(data.frame(Density = train$DES_Density, Perp = train$DES_Temperature_perp), aes(y = Density, x = Perp, color = "#8f8699")) + 
    geom_point(colour = "#591d91", shape = 1) + theme_grey() +
    labs(title = "DES Density and FGM Magnetic Field"),
  ggplot(data.frame(Density = train$DES_Density, Perp = ( 1 / train$DES_Temperature_perp )), aes(y = Density, x = Perp, color = "#8f8699")) + 
    geom_point(colour = "#591d91", shape = 1) + theme_grey() +
    labs(title = "DES Density and FGM Magnetic Field") + xlab("1 / Perp"),
  ggplot(data.frame(w = train$FGM_Magnetic_Field_w, z = train$FGM_Magnetic_Field_z), aes(y = w, x = z, color = "#8f8699")) + 
    geom_point(colour = "#591d91", shape = 1) + theme_grey() +
    labs(title = "FGM Magnetic Field"),
  ncol = 2
)
```

## Time Series Exploration
```{r}
glm.fit <- glmnetUtils::cv.glmnet(Selected ~ . - Time - Priority - SelectedF, data = train, family = "binomial")
log.odds <- predict(glm.fit, data)
probabilities <- exp(log.odds) / (1 + exp(log.odds))
f = "basic.csv"
save_predictions(probabilities, data$X, f)
evaluate(data, f)
```
```{r}
diffData <- data.frame(X = data$X, series_metric(data[,featureSubset], 20), data[, SEL_set])
diffTrain <- split_train(diffData)

glm.fit <- glmnetUtils::cv.glmnet(Selected ~ . - Time, data = diffTrain, family = "binomial")
log.odds <- predict(glm.fit, diffData)
probabilities <- exp(log.odds) / (1 + exp(log.odds))
f = "time.series.metric.csv"
save_predictions(probabilities, diffData$X, f)
evaluate(data, f)
```

## Combination Exploration
```{r}
#comb <- glm(Selected ~ . , data = train)
```

